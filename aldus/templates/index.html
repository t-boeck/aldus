{% extends "base.html" %}

{% block head %}
<style>
  h1 {
    text-align: center;
    margin-bottom: 30px;
    font-weight: 300;
  }
</style>
{% endblock %}

{% block content %}
<div class="text-center my-4">
  <img src="{{ url_for('static', filename='aldus.png') }}" alt="Aldus logo" class="img-fluid mb-2"
    style="max-height:80px">

  <h1 class="mb-1"><strong>Aldus</strong></h1>
  <h4 class="mb-4 fw-normal">The Bilingual Book Maker</h4>
</div>

<form action="{{ url_for('start') }}" method="POST" enctype="multipart/form-data" class="text-start">
  <div class="mb-3">
    <label for="english_file" class="form-label">Upload Book (<code>.txt</code>)</label>
    <input type="file" class="form-control" id="english_file" name="english_file" accept=".txt" required>
  </div>

  <div class="row mb-3">
    <div class="col">
      <label for="source_language" class="form-label">Source Language</label>
      <select class="form-select" id="source_language" name="source_language" onchange="updatePrompt()">
        <option value="english" selected>English</option>
        <option value="chinese">Chinese</option>
        <option value="spanish">Spanish</option>
        <option value="french">French</option>
      </select>
    </div>
    <div class="col">
      <label for="target_language" class="form-label">Target Language</label>
      <select class="form-select" id="target_language" name="target_language" onchange="updatePrompt()">
        <option value="chinese" selected>Chinese</option>
        <option value="english">English</option>
        <option value="spanish">Spanish</option>
        <option value="french">French</option>
      </select>
    </div>
  </div>

  <div class="mb-3">
    <label for="model" class="form-label">Select Model</label>
    <select class="form-select" id="model" name="model">
      <option value="deepseek-chat" selected>deepseek-chat</option>
      <option value="gpt-4o-mini">gpt-4o-mini</option>
      <option value="gpt-4o">gpt-4o</option>
    </select>
  </div>

  <div class="mb-3">
    <label for="api_key" class="form-label">API Key</label>
    <input type="password" class="form-control" id="api_key" name="api_key" required placeholder="sk-...">
  </div>

  <details class="mb-3">
    <summary class="mb-2 text-primary" style="cursor: pointer;">Advanced Options (Prompt & Context)</summary>
    <div class="card card-body bg-light">

      <div class="mb-3">
        <label for="font_size" class="form-label">Font Size (pt)</label>
        <select class="form-select" id="font_size" name="font_size">
          <option value="12">12</option>
          <option value="14">14</option>
          <option value="16">16</option>
          <option value="17" selected>17</option>
        </select>
        <div class="form-text">17pt is good for Chinese, 12pt is good for other languages.</div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label for="author" class="form-label">Author (Optional)</label>
          <input type="text" class="form-control" id="author" name="author" placeholder="e.g. Herman Melville"
            oninput="updatePrompt()">
        </div>
        <div class="col-md-4">
          <label for="year" class="form-label">Year (Optional)</label>
          <input type="text" class="form-control" id="year" name="year" placeholder="e.g. 1851"
            oninput="updatePrompt()">
        </div>
        <div class="col-md-4">
          <label for="genre" class="form-label">Genre/Style (Optional)</label>
          <input type="text" class="form-control" id="genre" name="genre" placeholder="e.g. 19th Century Novel"
            oninput="updatePrompt()">
        </div>
      </div>

      <div class="mb-3">
        <textarea class="form-control" id="system_prompt" name="system_prompt" rows="5"></textarea>
        <div class="form-text">Auto-generated based on your inputs. Edit manually if needed.</div>
      </div>
    </div>
  </details>

  <div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" id="test_mode" name="test_mode" value="yes">
    <label class="form-check-label" for="test_mode">
      Test Mode (translate only first 5 paragraphs)
    </label>
  </div>

  <button type="submit" class="btn btn-primary w-100">
    Translate
  </button>
</form>
{% endblock %}

{% block scripts %}
<script>
  function updatePrompt() {
    const src = document.getElementById('source_language').value;
    const tgt = document.getElementById('target_language').value;
    const author = document.getElementById('author').value.trim();
    const year = document.getElementById('year').value.trim();
    const genre = document.getElementById('genre').value.trim();

    const srcName = src.charAt(0).toUpperCase() + src.slice(1);
    const tgtName = tgt.charAt(0).toUpperCase() + tgt.slice(1);

    let prompt = `You are a professional literary translator, tasked with translating the provided text from ${srcName} to ${tgtName}.`;

    if (author || year || genre) {
      prompt += " Context:";
      if (author) prompt += ` Authored by ${author}.`;
      if (year) prompt += ` Published in ${year}.`;
      if (genre) prompt += ` Style/Genre: ${genre}.`;
    }

    prompt += ` Preserve the text's style, tone, nuance, and voice. Return ONLY the ${tgtName} translation with no additional commentary, greetings or extraneous text.`;

    document.getElementById('system_prompt').value = prompt;
  }
  // Initialize
  updatePrompt();
</script>
{% endblock %}